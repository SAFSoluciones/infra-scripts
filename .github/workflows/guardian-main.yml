name: Guardian Main
on:
  pull_request:

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar usuario y titulo
        uses: actions/github-script@v6
        with:
          script: |
            // --- CONFIGURACIÃ“N ---
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            const magicWord = 'hotfix'; // La palabra clave
            
            // Obtenemos datos del contexto
            const actor = context.actor;
            const title = context.payload.pull_request.title.toLowerCase(); // Convertimos a minÃºsculas
            
            console.log(`Usuario: ${actor} | TÃ­tulo: ${title}`);

            // --- LÃ“GICA DE VALIDACIÃ“N ---
            
            // Caso 1: Es un Hotfix de emergencia (Permitimos pasar a cualquiera)
            if (title.includes(magicWord)) {
              console.log("âœ… Acceso permitido por Hotfix.");
              return; // Salimos del script exitosamente
            }

            // Caso 2: Es un usuario VIP (Permitimos pasar)
            if (allowedUsers.includes(actor)) {
               console.log("âœ… Acceso permitido por Usuario Admin.");
               return; // Salimos exitosamente
            }

            // Caso 3: Ni es admin, ni es hotfix -> BLOQUEO
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ðŸ›‘ **ACCIÃ“N BLOQUEADA** ðŸ›‘\n\nHola @" + actor + ", no tienes permisos para ir a `main`.\n\nðŸ”¸ Si esto es una emergencia real, agrega la palabra **HOTFIX** al tÃ­tulo del PR.\nðŸ”¸ De lo contrario, cambia la rama destino a **`developer`**."
            });

            core.setFailed(`Usuario ${actor} no autorizado y no es un Hotfix.`);
