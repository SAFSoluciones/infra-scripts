name: Guardian de Main

on:
  pull_request:
    # --- LA CLAVE DEL √âXITO ---
    # Esto hace que el script corra no solo al abrir, sino
    # tambi√©n si cambian la rama base (edited) o reabren.
    types: [opened, synchronize, reopened, edited]

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar y Sobreescribir Estatus
        uses: actions/github-script@v6
        with:
          script: |
            // 1. OBTENER DATOS ACTUALIZADOS
            const actor = context.actor;
            const targetBranch = context.payload.pull_request.base.ref; // Hacia d√≥nde apunta AHORA
            const title = context.payload.pull_request.title.toLowerCase();

            console.log(`ü§ñ RE-EVALUANDO PR DE: ${actor}`);
            console.log(`üìç RAMA DESTINO ACTUAL: ${targetBranch}`);

            // 2. FUERZA BRUTA: SI NO ES MAIN, APRUEBA (Verde)
            // Esto "borra" (sobreescribe) cualquier error rojo anterior del mismo commit.
            if (targetBranch !== 'main') {
              console.log("‚úÖ Destino seguro (Developer/Otro). Autorizando inmediatamente.");
              return; 
            }

            // 3. SI ES MAIN, APLICAR REGLAS
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            
            // Regla Hotfix
            if (title.includes('hotfix')) {
              console.log("‚úÖ Es Main, pero es Hotfix.");
              return;
            }

            // Regla Admin
            if (allowedUsers.includes(actor)) {
               console.log("‚úÖ Es Main, pero es Admin.");
               return;
            }

            // 4. BLOQUEO (Solo si sigue apuntando a Main y no tiene permiso)
            console.log("‚õî BLOQUEANDO: Sigue apuntando a Main sin permiso.");
            
            // Intentamos dejar comentario (sin fallar si no se puede)
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "üõë **ACCI√ìN BLOQUEADA** üõë\n\nEste PR apunta a **MAIN**.\n\nüëâ **Soluci√≥n:** Edita este PR (arriba a la derecha) y cambia la base a **`developer`**. El check se pondr√° verde autom√°ticamente."
              });
            } catch (e) {}

            core.setFailed(`‚õî Bloqueado: Destino Main no autorizado.`);
