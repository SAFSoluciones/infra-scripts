name: GuardiÃ¡n de Main

on:
  # --- ESTA ES LA PARTE QUE FALTABA ---
  pull_request:
    branches: [ "main" ]
  # ------------------------------------
  workflow_call:

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar usuario
        uses: actions/github-script@v6
        with:
          script: |
            // --- CONFIGURACIÃ“N DE USUARIOS VIP ---
            // Escribe aquÃ­ los usuarios exactos
            const allowedUsers = ['TuUsuario', 'OtroAdmin', 'TechLead'];
            
            const actor = context.actor;
            console.log(`Usuario intentando PR a main: ${actor}`);

            // ValidaciÃ³n
            if (!allowedUsers.includes(actor)) {
              
              // 1. Comentario en el PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number, // Ajuste para funcionar con el trigger pull_request
                body: "ðŸ›‘ **Â¡ACCIÃ“N BLOQUEADA!** ðŸ›‘\n\nHola @" + actor + ", estÃ¡s intentando fusionar cambios directamente a `main`.\n\nâœ‹ **No tienes permisos para esta acciÃ³n.**\n\nâœ… Por favor cambia la rama destino hacia **`developer`**."
              });

              // 2. Bloquear Merge
              core.setFailed(`El usuario ${actor} no estÃ¡ autorizado para mergear a main.`);
            } else {
              console.log("âœ… Usuario autorizado.");
            }
