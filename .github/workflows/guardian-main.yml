name: Guardian de Main

on:
  pull_request:
    # ALERTA: Hemos quitado la l√≠nea 'branches: ["main"]'.
    # Esto hace que el script corra en TODAS las ramas.
    # - En 'developer' dar√° Verde (porque la l√≥gica lo permite).
    # - En 'main' dar√° Rojo (si no tienes permiso).

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar reglas de gobernanza
        uses: actions/github-script@v6
        with:
          script: |
            // --- CONFIGURACI√ìN ---
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            const magicWord = 'hotfix'; 
            
            // --- DATOS ---
            const actor = context.actor;
            const title = context.payload.pull_request.title.toLowerCase();
            const targetBranch = context.payload.pull_request.base.ref; 
            
            console.log(`Usuario: ${actor} | Rama Destino: ${targetBranch}`);

            // --- REGLA 1: SI NO VA A MAIN -> PASE LIBRE (VERDE ‚úÖ) ---
            if (targetBranch !== 'main') {
              console.log("‚úÖ La rama destino NO es main. Check Verde autorizado.");
              return; // Al hacer return aqu√≠, el script termina con √©xito.
            }

            // --- A PARTIR DE AQU√ç, SOLO APLICA SI VA A MAIN ---

            // Regla 2: Es Hotfix?
            if (title.includes(magicWord)) {
              console.log("‚úÖ Acceso permitido por Hotfix.");
              return;
            }

            // Regla 3: Es Admin?
            if (allowedUsers.includes(actor)) {
               console.log("‚úÖ Acceso permitido por Usuario Admin.");
               return;
            }

            // --- BLOQUEO (ROJO ‚ùå) ---
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "üõë **ACCI√ìN BLOQUEADA** üõë\n\nHola @" + actor + ", no tienes permisos para ir directo a `main`.\n\nüëâ Por favor cambia la rama destino a **`developer`**."
              });
            } catch (e) { console.log(e); }

            core.setFailed(`Usuario ${actor} no autorizado para main.`);
