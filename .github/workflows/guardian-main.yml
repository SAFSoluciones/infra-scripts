name: Guardian de Main

on:
  pull_request:
    # Sin filtros de branches, para que corra siempre y pueda dar el "Verde"

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar Permisos y Rama
        uses: actions/github-script@v6
        with:
          script: |
            // 1. OBTENER DATOS
            const actor = context.actor;
            const targetBranch = context.payload.pull_request.base.ref; // Hacia d√≥nde va el PR
            const title = context.payload.pull_request.title.toLowerCase();

            // 2. IMPRIMIR LOG PARA DEPURAR (M√≠ralo si falla)
            console.log("--------------------------------------------------");
            console.log(`ü§ñ ANALIZANDO PR DE: ${actor}`);
            console.log(`üìç RAMA DESTINO DETECTADA: ${targetBranch}`);
            console.log("--------------------------------------------------");

            // 3. REGLA DE ORO: SI NO ES MAIN, APRUEBA EN VERDE ‚úÖ
            if (targetBranch !== 'main') {
              console.log("‚úÖ La rama destino NO es main. El Guardi√°n autoriza el paso.");
              return; // ESTO HACE QUE EL CHECK SALGA VERDE
            }

            // 4. SI LLEGAMOS AQU√ç, ES PORQUE ES MAIN. APLICAMOS SEGURIDAD üîí
            
            // Lista de Admins
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            
            // ¬øEs Hotfix?
            if (title.includes('hotfix')) {
              console.log("‚úÖ Es Main, pero es Hotfix. Autorizado.");
              return;
            }

            // ¬øEs Admin?
            if (allowedUsers.includes(actor)) {
               console.log("‚úÖ Es Main, pero usuario es Admin. Autorizado.");
               return;
            }

            // 5. BLOQUEO FINAL (ROJO ‚ùå)
            // Solo llegamos aqu√≠ si: Es Main + No es Hotfix + No es Admin
            console.log("‚õî BLOQUEANDO: Intento no autorizado a Main.");
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "üõë **ACCI√ìN BLOQUEADA** üõë\n\nHola @" + actor + ", este PR va dirigido a **MAIN** y no tienes permisos.\n\n‚úÖ **Soluci√≥n:** Cambia la rama destino a **`developer`**."
              });
            } catch (e) {}

            core.setFailed(`‚õî BLOQUEADO: El usuario ${actor} intent√≥ ir a MAIN sin permiso.`);
