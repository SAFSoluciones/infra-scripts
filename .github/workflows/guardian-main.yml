name: Guardi√°n de Main

on:
  # Esto permite que este workflow sea llamado desde otros repositorios
  workflow_call:

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar usuario
        uses: actions/github-script@v6
        with:
          script: |
            // --- CONFIGURACI√ìN ---
            // Pon aqu√≠ los usuarios de GitHub (tal cual aparecen en su perfil)
            const allowedUsers = ['psaf-5', 'kmponcesalgado', 'wjlopezc'];
            
            // --- L√ìGICA ---
            const actor = context.actor;
            console.log(`Usuario intentando PR a main: ${actor}`);

            // Si el usuario NO est√° en la lista permitida...
            if (!allowedUsers.includes(actor)) {
              
              // 1. Poner comentario en el PR avisando del error
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: "üõë **¬°ACCI√ìN BLOQUEADA!** üõë\n\nHola @" + actor + ", est√°s intentando fusionar cambios directamente a `main`.\n\n‚ö†Ô∏è **No tienes permisos para esta acci√≥n.**\n\n‚úÖ Por favor, cierra este PR o cambia la rama destino hacia **`developer`**.\n\n*Este control es autom√°tico por pol√≠ticas de la organizaci√≥n.*"
              });

              // 2. Hacer fallar el check para bloquear el bot√≥n de Merge
              core.setFailed(`Usuario ${actor} no autorizado para mergear a main.`);
            } else {
              console.log("‚úÖ Usuario autorizado. El check ha pasado exitosamente.");
            }
