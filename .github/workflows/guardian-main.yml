name: Guardian Main

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar Permisos
        uses: actions/github-script@v6
        with:
          script: |
            const actor = context.actor;
            const targetBranch = context.payload.pull_request.base.ref;
            const title = context.payload.pull_request.title.toLowerCase();

            console.log(`ðŸ¤– REVISANDO PR DE: ${actor} HACIA ${targetBranch}`);

            // 1. SI NO ES MAIN, APROBAR (VERDE âœ…)
            if (targetBranch !== 'main') {
              console.log("âœ… Destino no es Main. Autorizado.");
              return; 
            }

            // 2. REGLAS PARA MAIN
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            if (title.includes('hotfix') || allowedUsers.includes(actor)) {
               console.log("âœ… Autorizado por Admin o Hotfix.");
               return;
            }

            // 3. BLOQUEO â›”
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ðŸ›‘ **BLOQUEADO** ðŸ›‘\n\nVas a **MAIN** sin permiso.\nðŸ‘‰ Cambia a **`developer`**."
              });
            } catch (e) {}

            core.setFailed(`â›” Bloqueado: ${actor} intentÃ³ ir a MAIN.`);
