name: Guardian de Main
on:
  pull_request:

permissions:
  pull-requests: write
  issues: write

jobs:
  verificar-permisos:
    runs-on: ubuntu-latest
    steps:
      - name: Validar usuario, titulo y rama
        uses: actions/github-script@v6
        with:
          script: |
            // --- CONFIGURACIÃ“N ---
            const allowedUsers = ['psaf-5', 'OtroAdmin']; 
            const magicWord = 'hotfix'; 
            
            // --- DATOS DEL CONTEXTO ---
            const actor = context.actor;
            const title = context.payload.pull_request.title.toLowerCase();
            // AquÃ­ capturamos hacia dÃ³nde va el PR (main, developer, etc.)
            const targetBranch = context.payload.pull_request.base.ref; 
            
            console.log(`Usuario: ${actor} | Rama Destino: ${targetBranch} | TÃ­tulo: ${title}`);

            // --- REGLA 0: SI NO VA A MAIN, DEJAR PASAR ---
            if (targetBranch !== 'main') {
              console.log("âœ… La rama destino NO es main. Se omite la validaciÃ³n.");
              return; // Salimos del script exitosamente
            }

            // --- REGLA 1: HOTFIX ---
            if (title.includes(magicWord)) {
              console.log("âœ… Acceso permitido por Hotfix.");
              return;
            }

            // --- REGLA 2: USUARIO VIP ---
            if (allowedUsers.includes(actor)) {
               console.log("âœ… Acceso permitido por Usuario Admin.");
               return;
            }

            // --- BLOQUEO (Solo llegamos aquÃ­ si va a MAIN y no cumple reglas 1 o 2) ---
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ðŸ›‘ **ACCIÃ“N BLOQUEADA** ðŸ›‘\n\nHola @" + actor + ", no tienes permisos para fusionar directamente a `main`.\n\nðŸ”¸ **SoluciÃ³n:** Cambia la rama destino a **`developer`**.\nðŸ”¸ **Emergencia:** Si es un Hotfix real, agrega la palabra **HOTFIX** al tÃ­tulo."
              });
            } catch (e) {
              console.log("Error al comentar: " + e);
            }

            core.setFailed(`Usuario ${actor} no autorizado para main.`);
